<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><style>:root{--accent-color:#FF4D4D}</style><title>Ephemeral MySQL for local testing using Docker Compose</title>
<meta name=description content><meta name=keywords content="docker,mysql,developer-tools"><meta property="og:url" content="https://mahesh-hegde.github.io/posts/mysql_local_using_compose/"><meta property="og:type" content="website"><meta property="og:title" content="Ephemeral MySQL for local testing using Docker Compose"><meta property="og:description" content><meta property="og:image" content="https://mahesh-hegde.github.io/"><meta property="og:image:secure_url" content="https://mahesh-hegde.github.io/"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="Ephemeral MySQL for local testing using Docker Compose"><meta name=twitter:description content><meta property="twitter:domain" content="https://mahesh-hegde.github.io/posts/mysql_local_using_compose/"><meta property="twitter:url" content="https://mahesh-hegde.github.io/posts/mysql_local_using_compose/"><meta name=twitter:image content="https://mahesh-hegde.github.io/"><link rel=canonical href=https://mahesh-hegde.github.io/posts/mysql_local_using_compose/><link rel=stylesheet type=text/css href=/css/normalize.min.css media=print><link rel=stylesheet type=text/css href=/css/main.min.css><link id=dark-theme rel=stylesheet href=/css/dark.min.css><script src=/js/bundle.min.27043ee3e4fae9fba993230b5c2ba193e1f265beeea9c49a69d028f72b22ccb5.js integrity="sha256-JwQ+4+T66fupkyMLXCuhk+HyZb7uqcSaadAo9ysizLU="></script></head><body><script type=text/javascript>setThemeByUserPref()</script><header class=header><nav class=header-nav><div class=nav-title><a class=nav-brand href=https://mahesh-hegde.github.io/>Mahesh's Blog</a></div><div class=nav-links><div class=nav-link><a href=https://mahesh-hegde.github.io/posts/>Posts</a></div><div class=nav-link><a href=https://mahesh-hegde.github.io/tags/>Tags</a></div><div class=nav-link><a href=https://mahesh-hegde.github.io/readings/>Readings</a></div><div class=nav-link><a href=https://mahesh-hegde.github.io/about/>About</a></div><div class=nav-link><a href=mailto:net.mahesh29@gmail.com><span data-feather=mail></span></a></div><div class=nav-link><a href=https://github.com/mahesh-hegde><span data-feather=github></span></a></div><div class=nav-link><a href=https://www.linkedin.com/in/mahesh-bhaskar-hegde/><span data-feather=linkedin></span></a></div><span class=nav-icons-divider></span><div class="nav-link dark-theme-toggle"><span id=dark-theme-toggle-screen-reader-target class=sr-only></span>
<a><span id=theme-toggle-icon data-feather=moon></span></a></div><div class=nav-link id=hamburger-menu-toggle><span id=hamburger-menu-toggle-screen-reader-target class=sr-only>menu</span>
<a><span data-feather=menu></span></a></div><ul class="nav-hamburger-list visibility-hidden"><li class=nav-item><a href=https://mahesh-hegde.github.io/posts/>Posts</a></li><li class=nav-item><a href=https://mahesh-hegde.github.io/tags/>Tags</a></li><li class=nav-item><a href=https://mahesh-hegde.github.io/readings/>Readings</a></li><li class=nav-item><a href=https://mahesh-hegde.github.io/about/>About</a></li><li class=nav-item><a href=mailto:net.mahesh29@gmail.com><span data-feather=mail></span></a></li><li class=nav-item><a href=https://github.com/mahesh-hegde><span data-feather=github></span></a></li><li class=nav-item><a href=https://www.linkedin.com/in/mahesh-bhaskar-hegde/><span data-feather=linkedin></span></a></li><li class="nav-item dark-theme-toggle"><span id=dark-theme-toggle-screen-reader-target class=sr-only>theme</span>
<a><span id=theme-toggle-icon data-feather=moon></span></a></li></ul></div></nav></header><main id=content><div class="post container"><div class=post-header-section><h1>Ephemeral MySQL for local testing using Docker Compose</h1><small role=doc-subtitle></small><p class=post-date>October 24, 2023</p><ul class=post-tags><li class=post-tag><a href=https://mahesh-hegde.github.io/tags/docker>docker</a></li><li class=post-tag><a href=https://mahesh-hegde.github.io/tags/mysql>mysql</a></li><li class=post-tag><a href=https://mahesh-hegde.github.io/tags/developer-tools>developer-tools</a></li></ul></div><div class=post-content><p><h2 id=why>Why?</h2><p>Many times tests are run against a simple database like H2 or SQLite, whereas production uses a heavier DB like MySQL. However, its many times desirable to run testing with the real DB. For example, when the application makes use of DB-specific features or quirks, it&rsquo;s required for proper testing.</p><p>Once upon a time it took long time to setup MySQL through distribution package manager, and tests ideally need ephemeral environments. But now with containers, we can run the same DB in local. Plus, with docker-compose and Docker volumes, we can easily create and tear-down data volumes, giving us clean state when we need.</p><p>Many months ago I wrote a post about using Docker compose to run a local instance of PostgreSQL for testing and / or experimentation. Similarly, this post shows a configuration for locally running <strong>MySQL</strong>.</p><h2 id=configuration>Configuration</h2><p>This should be in <code>docker-compose.yml</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>version</span>: <span style=color:#e6db74>&#39;3.9&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>services</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>mysql</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>image</span>: <span style=color:#ae81ff>mysql</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>environment</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>MYSQL_USER</span>: <span style=color:#ae81ff>myusername</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>MYSQL_PASSWORD</span>: <span style=color:#ae81ff>${MYSQL_PASSWORD}</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>MYSQL_ROOT_PASSWORD</span>: <span style=color:#ae81ff>${MYSQL_PASSWORD}</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>MYSQL_DATABASE</span>: <span style=color:#ae81ff>appdb</span> <span style=color:#75715e>## Use the name of Database used by application</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>volumes</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>mysql_data:/var/lib/mysql</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>127.0.0.1</span>:<span style=color:#ae81ff>3306</span>:<span style=color:#ae81ff>3306</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>volumes</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>mysql_data</span>:
</span></span></code></pre></div><p>I have kept the passwords as environment variables. But it shouldn&rsquo;t matter for most local environments if you hardcode them.</p><p>Replace the value of MYSQL_DATABASE by the DB name used by the application code.</p><p>Usage is fairly straightforward. Just make sure to run these commands in same directory as <code>docker-compose.yml</code> (or pass the file explicitly through <code>-f</code> flag).</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>## Set password as required, (if not hardcoded in YAML)</span>
</span></span><span style=display:flex><span>export MYSQL_PASSWORD<span style=color:#f92672>=</span>somePassword
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>## Start the MySQL server</span>
</span></span><span style=display:flex><span>docker compose up -d
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>## Connect to server using `mycli` (replace username and DB name accordingly)</span>
</span></span><span style=display:flex><span>mycli -D appdb -u myusername -h localhost -p <span style=color:#e6db74>&#34;</span>$MYSQL_PASSWORD<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>## Stop the server</span>
</span></span><span style=display:flex><span>docker compose down
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>## Stop the server and delete the data</span>
</span></span><span style=display:flex><span>docker compose down --volumes
</span></span></code></pre></div><h2 id=tips>Tips</h2><ul><li><p>If an application&rsquo;s docker image needs to access this server, It can&rsquo;t use <code>localhost:3306</code> - since the running container is on different docker network.</p><p>To work around this, attach it to the Docker network created by compose. You can get this network&rsquo;s name by running <code>docker network ls</code> and this network will be usually named like <code>${directory_of_compose_file}_default</code>. Once the application container is attached to this network, it can access the MySQL through hostname <code>mysql</code>.</p><p>For example, an application container which takes DB configuration through environment can be run like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker run --network<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;mysql_compose_default&#34;</span> --hostname <span style=color:#e6db74>&#34;myapp&#34;</span> --name <span style=color:#e6db74>&#34;myapp&#34;</span> -dp 127.0.0.1:8000:80 -e MYSQL_USER<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;myuser&#34;</span> -e MYSQL_PASSWORD<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;mypassword&#34;</span> -e MYSQL_HOST<span style=color:#f92672>=</span>mysql <span style=color:#e6db74>&#34;myapp-image:latest&#34;</span>
</span></span></code></pre></div></li><li><p>Many settings like password are set when the storage volume is initialized for the first time. So you cannot change these settings without deleting the volumes and starting again.</p></li><li><p>Finally, some DB drivers may try to connect to Unix Domain Socket instead of TCP socket if <code>localhost</code> is specified as DB host in connection strings. This domain socket will not exist because our MySQL is in docker. To avoid this behavior, try using the localhost IP (127.0.0.1) instead.</p></li></ul></p></div><div class=prev-next></div></div><aside class=post-toc><nav id=toc><nav id=TableOfContents><ul><li><a href=#why>Why?</a></li><li><a href=#configuration>Configuration</a></li><li><a href=#tips>Tips</a></li></ul></nav></nav></aside></main><footer class=footer><span>Made with &#10084;&#65039; using <a target=_blank href=https://github.com/526avijitgupta/gokarna>Gokarna</a></span></footer></body></html>