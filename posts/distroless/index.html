<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><style>:root{--accent-color:#FF4D4D}</style><title>Exploring distroless docker images</title>
<meta name=description content><meta name=keywords content='Containers,Linux'><meta property="og:url" content="https://mahesh-hegde.github.io/posts/distroless/"><meta property="og:type" content="website"><meta property="og:title" content="Exploring distroless docker images"><meta property="og:description" content><meta property="og:image" content="https://mahesh-hegde.github.io/"><meta property="og:image:secure_url" content="https://mahesh-hegde.github.io/"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="Exploring distroless docker images"><meta name=twitter:description content><meta property="twitter:domain" content="https://mahesh-hegde.github.io/posts/distroless/"><meta property="twitter:url" content="https://mahesh-hegde.github.io/posts/distroless/"><meta name=twitter:image content="https://mahesh-hegde.github.io/"><link rel=canonical href=https://mahesh-hegde.github.io/posts/distroless/><link rel=stylesheet type=text/css href=/css/normalize.min.css media=print><link rel=stylesheet type=text/css href=/css/main.min.css><link id=dark-theme rel=stylesheet href=/css/dark.min.css><script src=/js/bundle.min.fbe2f55794ed6ded1573152a130784ee5cb022de9676b19dd37d7559ee6f6fc6.js integrity="sha256-++L1V5Ttbe0VcxUqEweE7lywIt6WdrGd0311We5vb8Y="></script></head><body><script type=text/javascript>setThemeByUserPref()</script><header class=header><nav class=header-nav><div class=nav-title><a class=nav-brand href=https://mahesh-hegde.github.io/>Loop Invariant</a></div><div class=nav-links><div class=nav-link><a href=https://mahesh-hegde.github.io/posts/><span data-feather=book-open></span> Posts</a></div><div class=nav-link><a href=https://mahesh-hegde.github.io/tags/><span data-feather=tag></span> Tags</a></div><div class=nav-link><a href=https://mahesh-hegde.github.io/cv/><span data-feather=briefcase></span> CV</a></div><div class=nav-link><a href=https://mahesh-hegde.github.io/readings/><span data-feather=book></span> Readings</a></div><div class=nav-link><a href=mailto:net.mahesh29@gmail.com><span data-feather=mail></span></a></div><div class=nav-link><a href=https://github.com/mahesh-hegde><span data-feather=github></span></a></div><div class=nav-link><a href=https://www.linkedin.com/in/mahesh-bhaskar-hegde/><span data-feather=linkedin></span></a></div><span class=nav-icons-divider></span><div class="nav-link dark-theme-toggle"><span id=dark-theme-toggle-screen-reader-target class=sr-only></span>
<a><span id=theme-toggle-icon data-feather=moon></span></a></div><div class=nav-link id=hamburger-menu-toggle><span id=hamburger-menu-toggle-screen-reader-target class=sr-only>menu</span>
<a><span data-feather=menu></span></a></div><ul class="nav-hamburger-list visibility-hidden"><li class=nav-item><a href=https://mahesh-hegde.github.io/posts/><span data-feather=book-open></span> Posts</a></li><li class=nav-item><a href=https://mahesh-hegde.github.io/tags/><span data-feather=tag></span> Tags</a></li><li class=nav-item><a href=https://mahesh-hegde.github.io/cv/><span data-feather=briefcase></span> CV</a></li><li class=nav-item><a href=https://mahesh-hegde.github.io/readings/><span data-feather=book></span> Readings</a></li><li class=nav-item><a href=mailto:net.mahesh29@gmail.com><span data-feather=mail></span></a></li><li class=nav-item><a href=https://github.com/mahesh-hegde><span data-feather=github></span></a></li><li class=nav-item><a href=https://www.linkedin.com/in/mahesh-bhaskar-hegde/><span data-feather=linkedin></span></a></li><li class="nav-item dark-theme-toggle"><span id=dark-theme-toggle-screen-reader-target class=sr-only>theme</span>
<a><span id=theme-toggle-icon data-feather=moon></span></a></li></ul></div></nav></header><main id=content><div class="post container"><div class=post-header-section><h1>Exploring distroless docker images</h1><small role=doc-subtitle></small><p class=post-date>August 27, 2023</p><ul class=post-tags><li class=post-tag><a href=https://mahesh-hegde.github.io/tags/containers>Containers</a></li><li class=post-tag><a href=https://mahesh-hegde.github.io/tags/linux>Linux</a></li></ul></div><div class=post-content><p><p>I recently discovered the concept of <a href=https://github.com/GoogleContainerTools/distroless>distroless</a> docker images. However, this project is quite a few years old.<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup></p><p>The name may be quite misleading (much like &ldquo;serverless&rdquo;) - as distroless images are actually based on Debian (currently Debian 11, Bullseye). However, they don&rsquo;t contain most of the stuff which is there in standard debian image, which such as all the command line executables (<code>coreutils</code> etc..)</p><h3 id=whats-there-in-a-standard-debian-image>What&rsquo;s there in a standard Debian image?</h3><p>Let&rsquo;s pull and inspect a standard debian docker image:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker run -it debian:11 bash
</span></span></code></pre></div><p>Let me just list the packages installed in a standard debian image. Which is quite a lot.</p><pre tabindex=0><code>root@abccaea3d8d3:/# apt list --installed
Listing... Done
adduser/now 3.118 all [installed,local]
apt/now 2.2.4 amd64 [installed,local]
base-files/now 11.1+deb11u7 amd64 [installed,local]
base-passwd/now 3.5.51 amd64 [installed,local]
bash/now 5.1-2+deb11u1 amd64 [installed,local]
// ----------------------------------------------------------------------
// ----- AROUND 80 PACKAGES REDACTED FOR READABILITY OF THIS POST -------
// ----------------------------------------------------------------------
tar/now 1.34+dfsg-1 amd64 [installed,local]
tzdata/now 2021a-1+deb11u10 all [installed,local]
util-linux/now 2.36.1-8+deb11u1 amd64 [installed,local]
zlib1g/now 1:1.2.11.dfsg-2+deb11u2 amd64 [installed,local]
</code></pre><p>Now most of this will not be used by your production image. However, existence of all these packages creates two disadvantages:</p><ol><li><p>The final size of the image will be very high. Debian is the base image for most popular containerized applications, and since they&rsquo;re usually pinned to some point version and never updated again, almost every such image you pull will end up having slightly different layers, causing 100s of MBs of pulls.</p></li><li><p>The existence of tools like <code>sh</code> creates an attack surface. Many security exploits leverage the relative simplicity of invoking a shell command like <code>sh</code> and getting arbitrary command execution on the remote machine.</p></li></ol><h3 id=what-are-distroless-images>What are distroless images?</h3><p>Distroless images are a very stripped down version of Debian base system, consisting of only few essential libraries and files.</p><p>For language like Go which can carry its own dependencies, we can use the most barebones version called <code>static-debian11</code>, which is smaller than the alpine image! There&rsquo;s also <code>base-debian11</code> which contains minimum <code>glibc</code> for compiled languages like Rust which still depend on libc.</p><p>For languages like Java and NodeJS, there are variant images which consist of the minimal language runtime - such as <code>gcr.io/distroless/java11-debian11</code> and <code>gcr.io/distroless/java11-debian11</code>. (<strong>Note that you have to pull these by specifying the full registry URL</strong>, since these images are hosted in GCR instead of docker hub. I will use shorter names in the remainder of this article).</p><p>We can compare the sizes of <code>alpine:latest</code> which is also known for small storage size and widely used, vs the distroless <code>static-debian11</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ docker image ls --format <span style=color:#e6db74>&#39;{{.Size}}\t{{.Repository}}&#39;</span> | grep -E <span style=color:#e6db74>&#39;distroless|alpine&#39;</span>
</span></span><span style=display:flex><span>5.54MB  alpine
</span></span><span style=display:flex><span>2.45MB  gcr.io/distroless/static-debian11
</span></span></code></pre></div><p>We all know that Alpine Linux image is very small compared to standard debian etc.. because it uses <code>musl</code> and <code>busybox</code> over its GNU counterparts, even at the cost of some incompatibility. But the smallest distroless debian-based image is smaller than alpine!</p><p>There&rsquo;s a catch though, it doesn&rsquo;t contain anything like <code>sh</code> to explore what&rsquo;s inside it. Because there&rsquo;s almost no executables, our normal run / exec commands won&rsquo;t be much helpful.</p><pre tabindex=0><code>$ docker run -it gcr.io/distroless/static-debian11 sh
docker: Error response from daemon: failed to create task for container: failed to create shim task: OCI runtime create failed: runc create failed: unable to start container process: exec: &#34;sh&#34;: executable file not found in $PATH: unknown.
</code></pre><h3 id=exploring-the-distroless-image>Exploring the distroless image</h3><p>So we have two ways to explore it.</p><ol><li>We can export the image to a <code>tar</code> using <code>docker export</code> command, then unpack the tarball and inspect it.</li><li>Trickier, but we can bind mount a busybox binary into the image and run it.</li></ol><p>I have a particular affinity towards complicating things, so let&rsquo;s go with 2.</p><p>I have busybox-static installed which I will just bind-mount.</p><pre tabindex=0><code>$ docker run -v $(which busybox):/bin/busybox -it gcr.io/distroless/static-debian11 busybox sh


BusyBox v1.30.1 (Ubuntu 1:1.30.1-7ubuntu3) built-in shell (ash)
Enter &#39;help&#39; for a list of built-in commands.

/ # ls
bin   boot  dev   etc   home  lib   proc  root  run   sbin  sys   tmp   usr   var
</code></pre><p>Let&rsquo;s run <code>du</code> to <del>find out</del> guess which directories have larger amount of files.</p><pre tabindex=0><code>/ # du -hd 1
0       ./sys
0       ./dev
0       ./proc
4.0K    ./tmp
4.0K    ./sbin
156.0K  ./var
2.1M    ./bin
5.5M    ./usr
4.0K    ./boot
4.0K    ./root
308.0K  ./etc
8.0K    ./home
4.0K    ./run
4.0K    ./lib
8.1M    .
</code></pre><p>Ignore <code>/bin</code> because we mounted it. Most stuff comes from <code>/usr/share</code>. In that most of it comes from timezone data.</p><p>I would leave further analysis from here to the reader. The point is that distroless trims down most stuff from the base distribution.</p><h3 id=when-is-it-useful>When is it useful?</h3><p>Small storage size makes it compelling for variety of use cases. Many projects including kubernetes have standardized on distroless base images.</p><p>When I had the impulse to containerize some of my small side projects, I have used distroless base image for both <a href=https://github.com/mahesh-hegde/rrip>rrip</a> and <a href=https://github.com/mahesh-hegde/zserv>zserv</a>.</p><p>The size difference is however negligible when the application has dependencies like Node JS. Official alpine-based <code>node:20-alpine</code> image is 181MB while distroless <code>nodejs20-debian11</code> image is 170MB - not much of a difference.</p><p>However, it must be noted that there are many tradeoffs besides size.</p><ul><li><p>Debian based images will be more compatible with C libraries than Alpine based images - which can be a reason to pick distroless.</p></li><li><p>Distroless images lack shell (in release configuration at least) and thus are harder to debug especially in remote environments like Kubernetes.</p></li><li><p>Distroless images have, theoretically, lesser attack surface due to lack of standard distro executables.</p></li><li><p>If your application is mostly static but still depends on C runtime (like rust applications, or Go applications linked with CGO), you need <code>base-debian11</code> instead of <code>static-debian11</code>, which is 4 times larger than <code>alpine</code> at the time of writing. (Because <code>glibc</code> vs <code>musl</code>). So the choice depends on whether the application works well with <code>musl</code> and maybe other Alpine quirks, or expects a more standard environment.</p></li><li><p>If your application requires installing anything in the production image (not the build image in 2-stage build) through package manager, then distroless isn&rsquo;t a choice as of today.</p></li></ul><p>There&rsquo;s also one other candidate which has similar value proposition - that is RedHat UBI micro. I haven&rsquo;t really gotten an opportunity to try it yet. UBI micro is considerably larger than distroless / alpine, but it&rsquo;s based on RHEL which is preferred by some people / organizations.</p><h3 id=faq-why-not-use-from-scratch->FAQ: Why not use <code>FROM scratch</code> ?</h3><p><code>FROM scratch</code> is technically the most minimal image you can have, but it doesn&rsquo;t contain SSL certificates, DNS resolv.conf or timezone data, one or the other of which end up being required for real world applications.</p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>The repo was created in 2017 which is only 4 years after the initial release of Docker&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></p></div><div class=prev-next></div></div><aside class=post-toc><nav id=toc><nav id=TableOfContents><ul><li><ul><li><a href=#whats-there-in-a-standard-debian-image>What&rsquo;s there in a standard Debian image?</a></li><li><a href=#what-are-distroless-images>What are distroless images?</a></li><li><a href=#exploring-the-distroless-image>Exploring the distroless image</a></li><li><a href=#when-is-it-useful>When is it useful?</a></li><li><a href=#faq-why-not-use-from-scratch->FAQ: Why not use <code>FROM scratch</code> ?</a></li></ul></li></ul></nav></nav></aside></main><footer class=footer><span>&copy; 2024 Mahesh Hegde</span>
<span>Blog using <a target=_blank href=https://github.com/526avijitgupta/gokarna>Gokarna</a> theme.</span></footer></body></html>